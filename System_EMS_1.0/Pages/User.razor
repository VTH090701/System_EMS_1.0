@page "/user"
@using Data
@using Services
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@inject IApiService ApiService
@inject NavigationManager NavigationManager
@inject NotificationService notification
@inject DialogService DialogService
@using Newtonsoft.Json
@inject IJSRuntime JSRuntime

<RadzenRow>
    <RadzenColumn SizeLG="7" SizeMD="7" SizeSM="12" Size="12">
        <RadzenText TextStyle="TextStyle.H4"> Quản lý người dùng</RadzenText>
    </RadzenColumn>
    <RadzenColumn SizeLG="5" SizeMD="5" SizeSM="12" Size="12">
        <RadzenButton Text="Thêm người dùng" Style="float:right" Icon="add" Click="Adduser" Size="ButtonSize.Medium" class="rz-background-color-info-dark"></RadzenButton>
        @if (user != null)
        {
            <RadzenButton Style="float:right" Icon="edit" Click="Edituser" class="rz-mr-2" ButtonStyle="ButtonStyle.Secondary" Size="ButtonSize.Medium"></RadzenButton>

            @if (user.Status == true)
            {
                <RadzenButton Style="float:right;color: green" Icon="lock_open" Click="()=>Lockuser(user.Userid)" class="rz-mr-2" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Medium"></RadzenButton>
            }
            else
            {
                <RadzenButton Style="float:right;color: red" Icon="lock" Click="()=>Unlockuser(user.Userid)" class="rz-mr-2" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Medium"></RadzenButton>
            }
        }

    </RadzenColumn>
</RadzenRow>
<hr />



<RadzenRow>

    <RadzenColumn SizeLG="3" SizeMD="3" SizeSM="4" Size=" 12">
        <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-p-4 rz-mb-6 rz-border-radius-1" Style="border: var(--rz-grid-cell-border);">
            <RadzenText Style="font-size:18px;font-weight:bold">Danh sách người dùng</RadzenText>
            <RadzenListBox FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" FilterOperator="StringFilterOperator.StartsWith" AllowFiltering="true"
                           Data=@responGetUser TextProperty="Username" ValueProperty="Userid" AllowClear="true" @bind-Value=value_user
                           Style="width: 100%; max-width: 320px; height: 470px" Change="@(() => UserValueChanged(value_user))" />
        </RadzenStack>

    </RadzenColumn>

    <RadzenColumn SizeLG="9" SizeMD="9" SizeSM="8" Size=" 12">
        <RadzenRow Gap="1rem" class="rz-mb-4">
            <RadzenColumn SizeLG="4" SizeMD="4" SizeSM="12" Size=" 12">
                <RadzenStack>
                    @if (user != null)
                    {
                        <RadzenFormField Text="Id" Variant="@variant">
                            <RadzenTextBox @bind-Value="@user.Userid" Disabled />
                        </RadzenFormField>
                        <RadzenFormField Text="Tên đăng nhập" Variant="@variant">
                            <RadzenTextBox @bind-Value="@user.Username" Disabled />
                        </RadzenFormField>
                        
                    }
                </RadzenStack>
            </RadzenColumn>

            <RadzenColumn SizeLG="4" SizeMD="4" SizeSM="12" Size=" 12">
                <RadzenStack>
                    @if (user != null)
                    {
                        <RadzenFormField Text="Tên người dùng" Variant="@variant">
                            <RadzenTextBox @bind-Value="@user.Displayname" Disabled />
                        </RadzenFormField>
                        <RadzenFormField Text="Số điện thoại" Variant="@variant">
                            <RadzenTextBox @bind-Value="@user.Phonenumber" Disabled />
                        </RadzenFormField>
                      
                    }
                </RadzenStack>
            </RadzenColumn>

            <RadzenColumn SizeLG="4" SizeMD="4" SizeSM="12" Size=" 12">
                <RadzenStack>
                    @if (user != null)
                    {
                        <RadzenFormField Text="Email" Variant="@variant">
                            <RadzenTextBox @bind-Value="@user.Email" Disabled />
                        </RadzenFormField>
                        <RadzenFormField Text="Phòng ban" Variant="@variant">
                            <RadzenTextBox @bind-Value="@user.Deparmentname" Disabled />
                        </RadzenFormField>
                    }
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>


        @if (listRoles != null)
        {
            <RadzenDataGrid Data="@listRoles" TItem="RoleUser" AllowVirtualization="true" Style="height:450px"
                            AllowFiltering="true" FilterPopupRenderMode="PopupRenderMode.OnDemand" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" LogicalFilterOperator="LogicalFilterOperator.Or"
                            AllowSorting="true">
                <Columns>
                    <RadzenDataGridColumn TItem="RoleUser" Property="Rolename" Title="Tên quyền" />
                    <RadzenDataGridColumn TItem="RoleUser" Property="Description" Title="Mô tả quyền" />
                    <RadzenDataGridColumn TItem="RoleUser" Width="70px">
                        <Template Context="data">
                            @if (listRolesUser != null)
                            {

                                @if (listRolesUser.Any(item1 => item1.Rolename == data.Rolename) == true)
                                {
                                    var checktrue = true;
                                    <RadzenCheckBox TriState="false" Value="checktrue"
                                                    TValue="bool" Change="()=>RevokeUser(data.Rolename)" />
                                }
                                else
                                {
                                    var checkfalse = false;
                                    <RadzenCheckBox TriState="false" Value="checkfalse"
                                                    TValue="bool" Change="()=>GrantUser(data.Rolename)" />
                                }
                            }
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        }
    </RadzenColumn>
</RadzenRow>




@code {

    private bool isConnected;
    private ResponLogin us = new ResponLogin();
    private string value_user = "";
    private Variant variant = Variant.Outlined;
    private List<DepartmentModel> responDepartment = new List<DepartmentModel>();
    private ResponLogout responSaveUser = new ResponLogout();
    private ResponLogout responUpdateUser = new ResponLogout();
    private ResponLogout responGrantRolesUser = new ResponLogout();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender)
        {
            bool isReturn = await ReturnIndex();
            if (isReturn)
            {
                NavigationManager.NavigateTo("/");
            }
            else
            {
                isConnected = true;
                await GetListUser();
                await GetDepartment();
            }
            StateHasChanged();
        }
    }

    public async Task<bool> ReturnIndex()
    {
        us = await sessionStorage.GetItemAsync<ResponLogin>("us");
        if (us == null)
        {
            return true;
        }
        else
        {
            return false;
        }
    }

    private void NavRolesUser(string id)
    {

        NavigationManager.NavigateTo($"userroles/{id}");
    }

    private async Task GetDepartment()
    {
        var result = await ApiService.GetDepartment(us.Token);
        if (result != null && result.Code == 200)
        {
            responDepartment = JsonConvert.DeserializeObject<List<DepartmentModel>>(result.Value.ToString());
        }
    }
    private List<UserModel> responGetUser = new List<UserModel>();
    private async Task GetListUser()
    {
        var result = await ApiService.GetUser(us.Token);
        if (result != null && result.Code == 200)
        {
            var res = JsonConvert.DeserializeObject<List<UserModel>>(result.Value.ToString());
            responGetUser = res;
        }
    }

    private ResponLogout responLock = new ResponLogout();
    private ResponLogout responUnlock = new ResponLogout();
    private async Task Lockuser(string userid)
    {
        responLock = await ApiService.ChangeStatus(userid, false, us.Token);
        if (responLock.Code == 200)
        {
            notification.Notify(NotificationSeverity.Success, responLock.Message);
            await GetListUser();
        }
        else
        {
            notification.Notify(NotificationSeverity.Warning, responLock.Message);
        }
        await ReloadUser(userid);

    }

    private async Task Unlockuser(string userid)
    {
        responUnlock = await ApiService.ChangeStatus(userid, true, us.Token);
        if (responUnlock.Code == 200)
        {
            notification.Notify(NotificationSeverity.Success, responUnlock.Message);
            await GetListUser();
        }
        else
        {
            notification.Notify(NotificationSeverity.Warning, responUnlock.Message);
        }
        await ReloadUser(userid);

    }
    private UserModel user;
    
    private async Task UserValueChanged(string id)
    {
        user = responGetUser.FirstOrDefault(item => item.Userid == id);

        await GetListRoles();
        await GetListRolesUser();
    }
    
    private List<RoleUser> listRoles;
    private async Task GetListRoles()
    {
        var result = await ApiService.ListRoles(us.Token);
        if (result != null && result.Code == 200)
        {
            listRoles = JsonConvert.DeserializeObject<List<RoleUser>>(result.Value.ToString());
        }
        else if (result.Code == 404)
        {

        }
    }

    private List<RoleUser> listRolesUser = new List<RoleUser>();
    private async Task GetListRolesUser()
    {

        var result = await ApiService.ListRolesUser(user.Userid, us.Token);
        if (result != null && result.Code == 200)
        {
            var res = JsonConvert.DeserializeObject<List<RoleUser>>(result.Value.ToString());
            listRolesUser = res;
        }
        else if (result.Code == 404)
        {

        }

    }

    private async Task GrantUser(string roleName)
    {
        responGrantRolesUser = await ApiService.GrantRolesUser("grant", value_user, roleName, us.Token);
        if (responGrantRolesUser.Code == 200)
        {
            notification.Notify(NotificationSeverity.Success, responGrantRolesUser.Message);
        }
        else
        {

            notification.Notify(NotificationSeverity.Warning, responGrantRolesUser.Message);
        }

        await ReloadList();


    }

    private async Task RevokeUser(string roleName)
    {
        responGrantRolesUser = await ApiService.GrantRolesUser("revoke", value_user, roleName, us.Token);
        if (responGrantRolesUser.Code == 200)
        {
            notification.Notify(NotificationSeverity.Success, responGrantRolesUser.Message);
        }
        else
        {
            notification.Notify(NotificationSeverity.Warning, responGrantRolesUser.Message);
        }
        await ReloadList();


    }

    private async Task ReloadList()
    {
        await GetListRoles();
        await GetListRolesUser();
        StateHasChanged();
    }

    private async Task Adduser()
    {
        var result = await DialogService.OpenAsync("Thêm người dùng", ds =>
                                    {
    string name = "";
    string password = "";
    string display = "";
    string email = "";
    string phonenumber = "";
    string department = "";

    return @<RadzenStack Gap="1.5rem">
        <RadzenStack>
            <RadzenFormField Text="Tên đăng nhập" Variant="@variant">
                <RadzenTextBox @bind-Value="@name" />
            </RadzenFormField>
        </RadzenStack>
        <RadzenStack>
            <RadzenFormField Text="Mật khẩu" Variant="@variant">
                <RadzenPassword @bind-Value="@password" />
            </RadzenFormField>
        </RadzenStack>
        <RadzenStack>
            <RadzenFormField Text="Tên người dùng" Variant="@variant">
                <RadzenTextBox @bind-Value="@display" />
            </RadzenFormField>
        </RadzenStack>
        <RadzenStack>
            <RadzenFormField Text="Email" Variant="@variant">
                <RadzenTextBox @bind-Value="@email" />
            </RadzenFormField>
        </RadzenStack>
        <RadzenStack>
            <RadzenFormField Text="Số điện thoại" Variant="@variant">
                <RadzenTextBox @bind-Value="@phonenumber" />
            </RadzenFormField>
        </RadzenStack>
        <RadzenStack>
            @if (responDepartment != null)
        {
            <RadzenFormField Text="Phòng ban" Variant="@variant">
                <RadzenDropDownDataGrid @bind-Value="@department" Data=@responDepartment TextProperty="Departmentname" ValueProperty="Departmentid" Placeholder="Chọn phòng ban" />
            </RadzenFormField>
        }
        </RadzenStack>


        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
            <RadzenButton Text="Trở lại" Click="() => ds.Close(false)" ButtonStyle="ButtonStyle.Light" />
            <RadzenButton Text="Thêm" Click="() => SaveUserinModal(name,password,display,email,phonenumber,department)" Style="width: 80px;" />
        </RadzenStack>
    </RadzenStack>
        ;
                                                    });

    }

    private async Task SaveUserinModal(string name, string pass, string display, string email, string phone, string depart)
    {
        responSaveUser = await ApiService.SaveUser(name, pass, display, email, phone, depart, us.Token);
        if (responSaveUser.Code == 200)
        {
            notification.Notify(NotificationSeverity.Success, responSaveUser.Message);
            DialogService.Close();
            await GetListUser();
        }
        else
        {
            notification.Notify(NotificationSeverity.Warning, responSaveUser.Message);

        }
    }

    private async Task Edituser()
    {
        if (user != null)
        {
            var result = await DialogService.OpenAsync("Cập nhật người dùng", ds =>
                        {
    return @<RadzenStack Gap="1.5rem">
        <RadzenStack>
            <RadzenFormField Text="Tên người dùng" Variant="@variant">
                <RadzenTextBox @bind-Value="@user.Displayname" />
            </RadzenFormField>
        </RadzenStack>
        <RadzenStack>
            <RadzenFormField Text="Email" Variant="@variant">
                <RadzenTextBox @bind-Value="@user.Email" />
            </RadzenFormField>
        </RadzenStack>
        <RadzenStack>
            <RadzenFormField Text="Số điện thoại" Variant="@variant">
                <RadzenTextBox @bind-Value="@user.Phonenumber" />
            </RadzenFormField>
        </RadzenStack>
        
        @if (responDepartment != null)
    {
        <RadzenStack>
            <RadzenFormField Text="Department" Variant="@variant">
                <RadzenDropDownDataGrid @bind-Value="@user.Departmentid" Data=@responDepartment TextProperty="Departmentname" ValueProperty="Departmentid" Placeholder="Select Department" />
            </RadzenFormField>
        </RadzenStack>
    }

        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
            <RadzenButton Text="Cancel" Click="() => ds.Close(false)" ButtonStyle="ButtonStyle.Light" />
            <RadzenButton Text="Edit" Click="() => UpdateUserinModal(user.Userid, user.Displayname,user.Email,user.Phonenumber,user.Departmentid)" Style="width: 80px;" />
        </RadzenStack>

    </RadzenStack>
    ;
                    });

        }
        else
        {
            notification.Notify(NotificationSeverity.Warning, "Hãy chọn bệnh nhân");

        }
    }

    private async Task UpdateUserinModal(string id, string display, string email, string phone, string deid)
    {
        responUpdateUser = await ApiService.UpdateUser(id, display, email, phone, deid, us.Token);
        if (responUpdateUser.Code == 200)
        {
            notification.Notify(NotificationSeverity.Success, responUpdateUser.Message);
            DialogService.Close();
            //await GetUser();
        }
        else
        {
            notification.Notify(NotificationSeverity.Warning, responUpdateUser.Message);

        }
        await ReloadUser(id);

    }

    private async Task ReloadUser(string id)
    {
        await GetListUser();
        await GetUser(id);
        StateHasChanged();
    }

    private async Task GetUser(string id)
    {
        var result = responGetUser.FirstOrDefault(item => item.Userid == id);
        user = result;
    }
}
